---
layout: post
title: Docker BuildKit 介绍
date: 2019-04-08 16:22:48 +0800
tags: Docker
excerpt: 
comments: true
---

对于 Docker 和 Kubernetes 来说，在自身发展的壮大过程中，都会经历一个因为功能不断增加导致的软件结构庞杂的问题。对于 Kubernetes 来说，出于架构上的考量，
`kubectl` 等项目的代码都会逐渐从主项目中移除。对于 Docker 来说，事情更为复杂，它既要考虑开源，又要考虑自己的商业化，所以有了 moby 以及 `*kit` 等一系列项目。
下图清晰地展示出了 Docker 对于相关项目的一个架构规划:

![](https://images.techhive.com/images/article/2017/05/moby-project-100721192-large.jpg)

总体来说，Docker 希望将容器技术与容器产品分离开，核心技术是开源的，可扩展的，这样允许有其他人来基于同样的技术来构建类似于 Docker CE/Docker EE 这样的产品。
BuildKit 自 2017 年年底便已经实现，但似乎关注度不是很高(在国内)，在 CI/CD 系统中的应用也不是很广泛，本文将尽量全面地梳理 BuildKit 的内容。



## 为什么需要 BuildKit
除了上面说的商业以及架构上的考量，本身在构建这一块，Dockerfile 以及相应的机制也面临着一些问题

1. 并发程度不够好
2. 对 cache 的支持不好
3. 对 secret 的支持不好
4. 可扩展性不够好
5. ...

这些问题并不是说在现有的代码基础之上实现不了，而是综合来看，工作量比较大，而且到了一种必须审视现有架构的时机了。有了 moby 之后更是如此，这并不是一个孤立的问题，而是每个 docker 子功能(command)都会面临的机遇与挑战。

## BuildKit 长什么样子

通常来讲，我们将 Dockerfile 当做一个项目里的一个用于部署的配置文件。但从某种角度来说，Dockerfile 就是一种编程语言，他有自己特定的语法，有编译器（docker）,有最终的产出(image)。这样来看，`docker build` 做的就是编译器的工作。关于编译器的结构与性能，我们已经有了在各个语言方面的实现以及优化经验，完全可以应用于 dockerfile。

从最初的 buildkit 的 [proposal](https://gist.github.com/tonistiigi/059fc72c4630f066d94dafb5e0e70dc6)来看，也正是采用这样的视角。像 LLVM 一样，采用模块化的结构，每一个部分都是可以单独扩展的，只需要正彼此之间的接口兼容性。

![](https://cdn-images-1.medium.com/max/1024/1*VWogVHhCagxopvAKVFjBeA.jpeg)

BuiltKit 主要分为以下几个部分

* frontends: build 的描述定义，比如 Dockerfile
* solver,worker: 负责语法解析，生成中间机构，cache 管理
* exporter: 结果导出,比如现在的 image

有了抽象的 frontends 和 exporter，BuildKit 已经不再单单是针对 dockerfile 的一个优化，而是一个通用你的构建系统。



## Links
1. [Moby Project: Introducing BuildKit](https://blog.mobyproject.org/introducing-buildkit-17e056cc5317)
2. [Buildkit Proposal](https://gist.github.com/tonistiigi/059fc72c4630f066d94dafb5e0e70dc6)
