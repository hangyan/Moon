---
layout: post
title: 好的微服务系统
date: 2019-03-17 17:58:41 +0800
category: tech
excerpt: 监控，追踪，文档，测试
comments: true
---

前两天看到一篇文章, [Give Me Back My Monolith](http://www.craigkerstiens.com/2019/03/13/give-me-back-my-monolith/), 表达了对于微服务的一些不满。
其实这个争论早已有之，本来也是各有优劣，只是说现在微服务成了趋势，那么盲目的迁移以及不重视 monolith 的经验是非常不可取的。本文主要就是想谈一下在使用微服务架构的时候一些需要注意的点。

之前在一个比较大的公司做大数据的时候，当时的一个业务程序就是 monolith 的, 编译一次要几个小时，程序启动后要占用几十G的内存，虽然其中以静态资源为多。因为对性能以及响应时间的高要求，这样
的服务如果想往微服务演化是很困难，而且也是很不必要的。但是在很多初创公司以及对于对于性能等没有极端的要求时，微服务是比较合适的场合。

有了微服务的架构之后，我们必须面对它所带来的问题，以及用什么的方式来应对。

## Trace ID

在业务请求中，一旦发生异常，我们需要能够拿到尽可能多的关于此次请求的信息，日志，监控数据等等。一般我们可以用一个 uuid 来记录。
在单体服务中，一个请求过来，一般单个程序就能处理好。在这个程序中生成 uuid 并做关联是很简单的事。但在微服务中，情况会复杂很多。一个请求会涉及多个组件，各个组件用的语言不一定一样，
有的是 http, 有的是 rpc等等。这个时候，我们必须要确保每个组件都要使用同样的 uuid。比较好的做法是:

1. 请求发起方生成 uuid, 并通过 http header 等方式发给 api gateway
2. api gateway在请求后端组件时也将 uuid 通过 http header 传给后端组件
3. 各个组件在打日志以及上报监控数据时都通过这个 uuid 作为主键

但是这样还不够，最好是能将每个组件的日志用集中的方式收集起来，监控系统最好也是用同一个。这样我们就能通过 uuid 来检索出一次请求的主要数据。

## Monitor

监控是一个在微服务初期很容器被忽视的核心系统，但没有它我们就很难洞悉整个系统的现状。它能提供的信息非常多

1. 每个组件是否正常
2. 业务请求的各项指标如何，错误率如何
3. 产品的用户量，每个页面的使用次数等等。

只要觉得有用的地方，都可以加 counter 纳入统计。监控系统本身和 trace id 以及日志都是密不可分的。

## 测试

微服务给系统的测试带来了非常巨大的挑战。单元测试仍然是需要的，但是集成测试确变得非常困难。尤其是组件依赖非常多的时候，你很难比较简单地搭建出一个测试环境。
即时能够 mock 掉很多依赖，但是一个持续运行的自动化集成测试环境仍然是必须的。

## 调用链追踪

微服务一个必须要控制的事情就是服务的数量。同时要做到对于各个服务之间的依赖关系能够非常清晰。组件数量越多，依赖关系就越复杂。trace id可以协助理清楚这种依赖关系。


